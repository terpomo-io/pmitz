services:
  pmitz:
    build: .
    ports:
      - "8080:8080"
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - SPRING_DATASOURCE_URL=jdbc:postgresql://postgres:5432/pmitz
      - SPRING_DATASOURCE_USERNAME=pmitz
      - SPRING_DATASOURCE_PASSWORD=pmitz123
      - SPRING_DATASOURCE_DRIVER_CLASS_NAME=org.postgresql.Driver
      - SPRING_JPA_DATABASE_PLATFORM=org.hibernate.dialect.PostgreSQLDialect
      - SPRING_FLYWAY_ENABLED=false
      - PMITZ_API_KEY=${PMITZ_API_KEY:-}
    depends_on:
      - postgres
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  postgres:
    image: postgres:13-alpine
    environment:
      - POSTGRES_DB=pmitz
      - POSTGRES_USER=pmitz
      - POSTGRES_PASSWORD=pmitz123
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U pmitz -d pmitz"]
      interval: 10s
      timeout: 5s
      retries: 5
    command: |
      bash -c "
        echo 'CREATE SCHEMA IF NOT EXISTS dbo;
        CREATE TABLE IF NOT EXISTS dbo.usage (
          usage_id SERIAL PRIMARY KEY,
          feature_id VARCHAR(255) NOT NULL,
          product_id VARCHAR(255) NOT NULL,
          user_grouping VARCHAR(255) NOT NULL,
          limit_id VARCHAR(255) NOT NULL,
          window_start TIMESTAMP NULL,
          window_end TIMESTAMP NULL,
          units INT NOT NULL,
          expiration_date TIMESTAMP NULL,
          updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL
        );
        CREATE INDEX IF NOT EXISTS idx_usage_limit_id ON dbo.usage (limit_id);
        CREATE INDEX IF NOT EXISTS idx_usage_feature_product_user ON dbo.usage (feature_id, product_id, user_grouping);
        CREATE TABLE IF NOT EXISTS dbo.user_limit (
          usage_id SERIAL PRIMARY KEY,
          limit_id VARCHAR(255) NOT NULL,
          feature_id VARCHAR(255) NOT NULL,
          user_group_id VARCHAR(255) NOT NULL,
          limit_type VARCHAR(255) NOT NULL,
          limit_value INT NOT NULL,
          limit_unit VARCHAR(255),
          limit_interval VARCHAR(255),
          limit_duration INT
        );
        DO \$\$ BEGIN
          IF NOT EXISTS (SELECT 1 FROM pg_constraint WHERE conname = \"c_limit\") THEN
            ALTER TABLE dbo.user_limit ADD CONSTRAINT c_limit UNIQUE (limit_id,feature_id,user_group_id);
          END IF;
        END \$\$;' > /docker-entrypoint-initdb.d/init.sql &&
        docker-entrypoint.sh postgres
      "

volumes:
  postgres_data:
    driver: local
